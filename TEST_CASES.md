# MVP测试用例验证清单

本文档包含所有必过测试用例的验证方法和预期结果。

## 测试环境准备

1. 启动后端服务：`pnpm run dev:backend`
2. 启动前端服务：`pnpm run dev:frontend`
3. 访问：http://localhost:5173

---

## 测试用例1：规则命中拒绝

### 测试目的
验证系统能够正确拒绝包含危险命令、敏感信息的输入。

### 测试步骤

#### 测试1.1：危险命令词
1. 点击右下角✨按钮打开浮窗
2. 输入：`<script>alert(1)</script>`
3. 点击"预览效果"

**预期结果**：
- 显示错误提示："因安全策略未通过，未执行任何更改：包含危险命令：<script"
- 不生成预览

#### 测试1.2：系统命令
1. 输入：`rm -rf /`
2. 点击"预览效果"

**预期结果**：
- 显示错误提示："因安全策略未通过，未执行任何更改：包含危险命令：rm -rf"

#### 测试1.3：敏感信息（手机号）
1. 输入：`把主标题改成：客服电话13812345678`
2. 点击"预览效果"

**预期结果**：
- 成功生成预览（敏感信息已脱敏）
- 在审计日志中，手机号应显示为 `1********`

#### 测试1.4：敏感信息（邮箱）
1. 输入：`把主标题改成：联系我们test@example.com`
2. 点击"预览效果"

**预期结果**：
- 成功生成预览（邮箱已脱敏）
- 在审计日志中，邮箱应显示为 `tes***@example.com`

---

## 测试用例2：越权选择器

### 测试目的
验证系统仅允许白名单选择器的修改。

### 测试步骤

#### 测试2.1：非白名单选择器
由于意图解析器只支持白名单内的操作，需要通过API直接测试。

使用浏览器开发者工具Console执行：

```javascript
fetch('/api/mvp/compile', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    text: '修改footer',
    session_id: localStorage.getItem('mvp_session_id')
  })
}).then(r => r.json()).then(console.log);
```

**预期结果**：
- 返回错误："无法识别您的需求" 或解析失败

---

## 测试用例3：值域越界

### 测试目的
验证系统仅允许白名单内的颜色值。

### 测试步骤

#### 测试3.1：非白名单颜色
1. 输入：`主题色改为红色`
2. 点击"预览效果"

**预期结果**：
- 显示错误："无法识别您的需求" 或 没有识别到颜色变更

#### 测试3.2：正确的颜色值
1. 输入：`主题色改为绿色`
2. 点击"预览效果"

**预期结果**：
- 成功生成预览
- 显示预览变更：🎨 样式 --color-primary → green

---

## 测试用例4：长度越界

### 测试目的
验证文本长度限制（最多40字符）。

### 测试步骤

#### 测试4.1：超长标题（>40字符）
1. 输入：`把主标题改成：这是一个非常非常非常非常非常非常非常非常长的标题超过四十个字符`
2. 点击"预览效果"

**预期结果**：
- 显示错误："因安全策略未通过，未执行任何更改：text长度不能超过40字符"

#### 测试4.2：正常长度标题
1. 输入：`把主标题改成：周末狂欢开始啦`
2. 点击"预览效果"

**预期结果**：
- 成功生成预览
- 显示：📝 文本 #hero-title → "周末狂欢开始啦"

---

## 测试用例5：撤销功能

### 测试目的
验证一步撤销功能。

### 测试步骤

1. 输入：`主题色改为绿色`
2. 点击"预览效果"
3. 点击"应用变更"
4. 等待提示"变更已应用"
5. 观察页面主题色变为绿色
6. 点击"撤销上次变更"按钮

**预期结果**：
- 页面主题色恢复为默认蓝色
- 显示提示："已撤销变更"
- 撤销按钮消失

---

## 测试用例6：过期恢复

### 测试目的
验证15分钟TTL自动恢复。

### 测试步骤

#### 测试6.1：刷新页面恢复
1. 应用任意变更（如：`把主标题改成：测试标题`）
2. 刷新浏览器页面

**预期结果**：
- 如果未超过15分钟：变更保持
- 如果超过15分钟：页面恢复初始状态

#### 测试6.2：localStorage过期检查
在浏览器开发者工具Console执行：

```javascript
const stored = localStorage.getItem('mvp_transform');
const data = JSON.parse(stored);
console.log('过期时间:', new Date(data.expiresAt));
console.log('剩余时间(分钟):', ((data.expiresAt - Date.now()) / 60000).toFixed(2));
```

**预期结果**：
- 显示过期时间为应用后15分钟

#### 测试6.3：修改localStorage测试立即过期
在Console执行：

```javascript
const stored = localStorage.getItem('mvp_transform');
const data = JSON.parse(stored);
data.expiresAt = Date.now() - 1000; // 设置为已过期
localStorage.setItem('mvp_transform', JSON.stringify(data));
// 等待1分钟后，系统自动检查过期
```

**预期结果**：
- 1分钟内页面自动刷新并恢复初始状态

---

## 测试用例7：频控机制

### 测试目的
验证频率限制（IP: 10次/分钟，会话: 6次/分钟）。

### 测试步骤

#### 测试7.1：会话频率限制
1. 快速连续点击"预览效果"按钮7次（每次输入相同内容）
2. 观察第7次请求的响应

**预期结果**：
- 第1-6次：正常返回
- 第7次：返回错误 "频率限制：会话频率限制：每分钟最多6次请求"
- HTTP状态码：429

#### 测试7.2：触发封禁
1. 继续快速请求超过10次
2. 访问管理端：http://localhost:5173/admin
3. 查看审计日志

**预期结果**：
- 超过限制后，会话被临时封禁
- 后续请求返回："访问被拒绝：您已被封禁"
- HTTP状态码：403
- 管理端审计日志中显示封禁记录

---

## 完整功能测试流程

### 流程1：修改主标题

1. 输入：`把主标题改成：周末狂欢`
2. 预览 → 应用
3. 验证：页面主标题变为"周末狂欢"
4. 撤销
5. 验证：恢复为"欢迎来到我们的平台"

### 流程2：修改副标题

1. 输入：`把副标题改成：限时优惠享不停`
2. 预览 → 应用
3. 验证：副标题变为"限时优惠享不停"

### 流程3：切换主题色

1. 输入：`主题色改为绿色`
2. 预览 → 应用
3. 验证：促销条和按钮变为绿色
4. 输入：`主题色改为琥珀色`
5. 预览 → 应用
6. 验证：颜色变为琥珀色

### 流程4：隐藏/显示促销条

1. 输入：`隐藏促销条`
2. 预览 → 应用
3. 验证：顶部促销条消失
4. 输入：`显示促销条`
5. 预览 → 应用
6. 验证：促销条重新出现

### 流程5：组合变更

1. 输入：
```
把主标题改成：双十一大促
主题色改为绿色
隐藏促销条
```

**注意**：当前意图解析器每次只支持一种操作类型。如需测试多项变更，需要分别输入。

---

## 管理端测试

### 访问管理端

1. 访问：http://localhost:5173/admin
2. 验证：显示审计日志列表

### 测试功能

#### 1. 查看统计数据
- 验证显示：总请求数、最近拒绝数、最近错误数

#### 2. 过滤日志
- 选择"操作"过滤：compile / apply / undo
- 选择"状态"过滤：success / error / rejected
- 验证：列表正确过滤

#### 3. 查看详情
- 点击任意日志的📄按钮
- 验证：弹窗显示完整JSON详情

#### 4. 封禁功能
- 点击任意日志的🚫按钮
- 确认封禁
- 验证：提示"封禁成功"
- 测试：尝试使用该会话/IP请求，应返回403

#### 5. 刷新日志
- 点击"🔄 刷新"按钮
- 验证：日志列表更新

---

## 安全策略验证

### CSP检查

1. 打开浏览器开发者工具 → Network标签
2. 刷新页面
3. 查看响应头

**预期结果**：
- Content-Security-Policy 包含：`default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'`

### XSS防护检查

1. 输入：`把主标题改成：<img src=x onerror=alert(1)>`
2. 如果通过了文本审查，应用变更后

**预期结果**：
- 页面标题显示为纯文本：`<img src=x onerror=alert(1)>`
- 不执行JavaScript

---

## 验收通过标准

所有以下条件必须满足：

- [ ] 测试用例1（规则拒绝）：全部4个子测试通过
- [ ] 测试用例2（越权选择器）：拒绝非白名单选择器
- [ ] 测试用例3（值域越界）：拒绝非白名单颜色
- [ ] 测试用例4（长度越界）：拒绝超长文本
- [ ] 测试用例5（撤销）：撤销功能正常
- [ ] 测试用例6（过期）：TTL生效
- [ ] 测试用例7（频控）：频率限制和封禁生效
- [ ] 完整流程：主标题、副标题、主题色、促销条均可正常修改
- [ ] 管理端：审计日志、封禁功能正常
- [ ] 安全策略：CSP生效，XSS防护有效
- [ ] 无真实密钥泄露
- [ ] 页面可正常访问，无报错

---

## 注意事项

1. 测试前清空localStorage：`localStorage.clear()`
2. 测试频控时注意等待1分钟窗口重置
3. 管理端没有身份验证（MVP版本），生产环境需添加
4. 所有数据存储在内存中，重启后端会清空
