# 自然语言驱动站点即时改造系统

这是一个安全优先的互动式网站改造系统，允许用户通过自然语言输入来即时、可回滚地改造网站的呈现层。

## 功能特性

### 核心功能
- ✅ **自然语言输入**：通过右下角"提需求"按钮输入改造请求
- ✅ **安全DSL**：所有改造通过声明式DSL执行，只允许白名单内的安全操作
- ✅ **即时应用**：改造立即生效，无需刷新页面
- ✅ **可回滚**：支持撤销和重置到初始状态
- ✅ **会话隔离**：每个访客独立会话，互不影响
- ✅ **自动过期**：会话30分钟后自动过期

### 安全特性
- 🔒 **多级安全审查**：危险指令检测、注入防护、违禁内容过滤
- 🔒 **选择器白名单**：只允许预定义的安全DOM选择器
- 🔒 **速率限制**：每IP每分钟10次，每会话每分钟6次
- 🔒 **IP封禁**：超限自动封禁，支持手动封禁/解封
- 🔒 **日志脱敏**：敏感信息自动脱敏处理
- 🔒 **CSP防护**：严格的内容安全策略

### 支持的改造类型
1. **文本修改**：修改标题、副标题、描述等文本内容
2. **主题颜色**：更改主题色（蓝色、红色、绿色、紫色等）
3. **显示隐藏**：显示或隐藏公告横幅等元素

## 文件结构

```
app-project/
├── server/                    # 后端服务
│   ├── index.js              # 主服务器文件（API端点）
│   ├── store.js              # 内存存储模块
│   ├── dsl.js                # DSL验证器
│   ├── policy.js             # 策略引擎（安全检查）
│   ├── rateLimit.js          # 速率限制
│   ├── intentParser.js       # 意图解析器
│   └── snapshot.js           # 快照和回滚系统
│
├── src/                      # 前端代码
│   ├── App.vue               # 主应用组件
│   ├── Admin.vue             # 管理端页面
│   ├── dslExecutor.js        # DSL执行引擎
│   └── main.js               # 入口文件
│
├── package.json              # 依赖配置
└── vite.config.js            # Vite配置
```

## 使用方法

### 1. 启动系统

系统已经在运行中（端口5173）。如果需要重新启动：

```bash
# 已经运行中，无需执行
pnpm run dev
```

### 2. 访问应用

- **主页**：http://localhost:5173
- **管理端**：http://localhost:5173/admin

### 3. 使用示例

点击右下角"💬 提需求"按钮，输入以下示例：

#### 示例1：修改文本
```
修改标题为"欢迎访问我的网站"
```

#### 示例2：更改主题颜色
```
将主题改为蓝色
```

#### 示例3：隐藏元素
```
隐藏公告横幅
```

#### 示例4：显示元素
```
显示公告横幅
```

### 4. 撤销和重置

- **撤销**：点击"↶ 撤销"按钮撤销最后一次改造
- **重置**：点击"⟲ 重置"按钮恢复到初始状态

## API端点

### 用户端点

1. **编译DSL**
   - `POST /api/v1/transform/compile`
   - 将自然语言转换为DSL

2. **应用改造**
   - `POST /api/v1/transform/apply`
   - 应用DSL改造

3. **撤销改造**
   - `POST /api/v1/transform/undo`
   - 撤销最后N步改造

4. **重置**
   - `POST /api/v1/transform/reset`
   - 重置到初始状态

5. **会话状态**
   - `GET /api/v1/session/state`
   - 获取会话状态

### 管理端点

1. **系统指标**
   - `GET /api/v1/admin/metrics`
   - 获取系统统计数据

2. **审计日志**
   - `GET /api/v1/admin/audit`
   - 获取审计日志

3. **封禁管理**
   - `POST /api/v1/admin/ban` - 封禁IP或会话
   - `POST /api/v1/admin/unban` - 解封

## 安全配置

### 速率限制
- **每IP**：每分钟10次，每小时200次
- **每会话**：每分钟6次，最多20轮对话
- **封禁时长**：1小时

### 选择器白名单
```
#hero-title         - 主标题
#hero-subtitle      - 副标题
#hero-description   - 描述
.promo-banner       - 公告横幅
.announcement       - 通知栏
#carousel           - 轮播
.footer             - 页脚
```

### 支持的颜色
```
蓝色 - #4a90e2
红色 - #e74c3c
绿色 - #2ecc71
紫色 - #9b59b6
橙色 - #f39c12
黑色 - #2c3e50
白色 - #ecf0f1
灰色 - #95a5a6
```

## 数据存储

**重要**：系统采用纯内存存储，符合Vercel等无服务器环境的部署要求：
- ✅ 所有数据存储在内存中（Map、对象等）
- ✅ 重启后数据会丢失（正常行为）
- ❌ 不使用文件系统
- ❌ 不使用数据库

## 技术栈

### 前端
- Vue 3 (Composition API)
- Vue Router
- 原生CSS

### 后端
- Node.js + Express
- 内存存储（Map/对象）

### 安全
- 多级审查机制
- 速率限制
- IP封禁
- 日志脱敏
- CSP保护

## 监控与管理

访问 http://localhost:5173/admin 查看：
- 实时系统指标
- 审计日志
- 封禁管理
- 速率限制状态

## 注意事项

1. **安全优先**：系统设计遵循"默认拒绝"原则，只允许白名单内的操作
2. **仅呈现层**：只改造页面显示，不触达数据层
3. **禁止输入敏感信息**：不要输入密码、密钥等敏感信息
4. **会话过期**：30分钟后会话自动过期，改造被重置
5. **内存存储**：重启后所有数据会丢失

## 快捷键

- `Cmd/Ctrl + K` - 打开/关闭提需求对话框
- `Cmd/Ctrl + Enter` - 发送请求

## 故障排查

### 问题：请求被拒绝
- 检查是否触发了速率限制
- 检查输入是否包含违禁内容
- 查看错误消息获取详细原因

### 问题：改造未生效
- 检查浏览器控制台是否有错误
- 确认选择器是否在白名单内
- 尝试刷新页面

### 问题：会话过期
- 会话TTL为30分钟，过期后自动重置
- 重新提交请求会创建新会话

## 开发团队说明

此系统完全按照"自然语言驱动站点即时改造｜安全优先的开发需求书（V1）"实施，包括：
- ✅ 完整的安全DSL系统
- ✅ 多级安全审查
- ✅ 速率限制和配额
- ✅ 快照和回滚
- ✅ 管理端监控
- ✅ 纯内存存储
- ✅ 所有代码均为中文注释
